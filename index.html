<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Farcaster Flip (Auto Wallet Connect)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- FRAME META (Farcaster compatible) -->
  <meta property="fc:frame" content="vNext" />
  <meta property="fc:frame:button:1" content="Flip Now" />
  <meta property="fc:frame:image" content="arbitrum.png" />
  <meta property="fc:frame:post_url" content="./" />
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Inter', Arial, sans-serif;
      color: #fff;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center; justify-content: center;
    }
    .app {
      width: 100%;
      max-width: 410px;
      margin: auto;
    }
    .glass {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(14px);
      border-radius: 28px;
      padding: 2.2rem 1.7rem 1rem 1.7rem;
      box-shadow: 0 4px 32px rgba(31,38,135,.4);
      border: 1.2px solid rgba(255,255,255,0.25);
      margin-bottom: 1.3rem;
      text-align: center;
    }
    .coin {
      margin: 24px auto 16px auto;
      width: 92px; height: 92px;
      border-radius: 50%;
      background: linear-gradient(135deg,#ffd700,#ffed4e);
      display: flex; align-items:center; justify-content:center;
      font-size: 2.5rem; font-weight: 700; color: #222;
      box-shadow: 0 2px 12px #0002;
      transition: .8s cubic-bezier(.19,1,.22,1);
    }
    .coin.heads { background: linear-gradient(135deg,#ffd700,#ffed4e); color: #333;}
    .coin.tails { background: linear-gradient(135deg,#bbb,#eee); color: #444;}
    .flip-btn {
      padding: 15px 36px;
      border-radius: 22px;
      border: none;
      font-size: 1.2rem;
      background: linear-gradient(135deg,#ff6b6b,#ff8e53);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      margin-bottom: 8px;
      box-shadow: 0 4px 15px #ff6b6b22;
      transition: .2s;
    }
    .flip-btn[disabled] {
      opacity: 0.6; cursor:not-allowed;
    }
    .leaderboard {
      margin-top: 24px;
      background: rgba(255,255,255,0.07);
      border-radius: 18px;
      padding: 1.2rem 1rem 0.5rem 1rem;
      box-shadow: 0 2px 10px #0001;
    }
    .lb-row {
      display: flex; justify-content: space-between;
      align-items:center; border-bottom: 1px solid #fff3;
      padding: 7px; font-size: 1.04rem;
    }
    .lb-row:last-child { border: none; }
    .toast {
      background: rgba(255,255,255,0.19);
      backdrop-filter: blur(14px);
      border-radius: 13px;
      padding: 18px 26px;
      color: #fff; font-weight: 500;
      position: fixed; top: 28px; right: 16px; z-index:11;
      min-width: 225px;
      border-left: 7px solid #4ecdc4;
      box-shadow: 0 8px 36px #0003;
      animation: fadein .45s;
      font-size: 1rem;
    }
    .toast.err { border-left: 7px solid #ff6b6b;}
    @keyframes fadein {from{opacity:0;right:-50px;}to{opacity:1;right:16px;}}
    @media(max-width:520px){.app{max-width:98vw;} .glass{padding-left:2vw;padding-right:2vw;}}
  </style>
</head>
<body>
  <div class="app">
    <div class="glass" id="mainUI" style="display:none;">
      <h2>ü™ô Flip on Arbitrum</h2>
      <div id="walletInfo" style="padding-bottom:7px;font-size:1.1rem;"></div>
      <div class="coin" id="coin">?</div>
      <button class="flip-btn" id="flipBtn">Flip Coin</button>
      <div style="margin:10px 0 4px 0;">
        Flips: <b id="statFlips">0</b> | Rewards: <b id="statRewards">0</b>
      </div>
      <div class="leaderboard" id="lbWrap">
        <div style="font-weight:600;margin-bottom:8px;">üèÜ Leaderboard</div>
        <div id="lb"></div>
      </div>
    </div>
    <div id="loading" style="padding:64px 0;text-align:center;">‚åõ Loading...</div>
    <div id="toast" style="display:none;"></div>
  </div>
  <script type="module">
    // ---- ESM.SH IMPORTS (wagmi+ethers+farcaster MINIAPP Connect) ----
    import { createConfig, getAccount, watchAccount } from "https://esm.sh/@wagmi/core";
    import { arbitrum } from "https://esm.sh/@wagmi/core/chains";
    import { farcasterMiniApp } from "https://esm.sh/@farcaster/miniapp-wagmi-connector";
    import { ethers } from "https://esm.sh/ethers@6.10.0";
    // ---- CONFIG: force Farcaster auto-connect, remove connectBtn ----
    const config = createConfig({
      chains: [arbitrum],
      connectors: [farcasterMiniApp()],
      transports: { [arbitrum.id]: { url: arbitrum.rpcUrls.default.http[0] } }
    });

    let stats = { flips: 0, rewards: 0, addr: "", connected: false };

    // ---------------- UI: Toast -----------------
    function toast(msg, err) {
      let t = document.getElementById("toast");
      t.innerText = msg;
      t.className = "toast"+(err?" err":"");
      t.style.display = "block";
      setTimeout(()=>{ t.style.display="none"; },3000);
    }

    // -------- Wagmi account auto-connect logic --------
    async function tryAutoConnect() {
      let { isConnected, address } = getAccount(config);
      // Listen for wallet connection updates too!
      watchAccount(config, {
        onChange(account) {
          isConnected = account.isConnected;
          address = account.address;
          handleWallet(isConnected, address);
        }
      });
      handleWallet(isConnected, address);
    }

    // -------------- Show/hide correct UI --------------
    function handleWallet(isConnected, address) {
      if(isConnected && address) {
        stats.addr = address;
        stats.connected = true;
        document.getElementById("mainUI").style.display = "";
        document.getElementById("walletInfo").innerText =
          "üü¢ "+address.slice(0,6)+"..."+address.slice(-4);
        document.getElementById("loading").style.display="none";
        fetchStats();
      } else {
        document.getElementById("mainUI").style.display = "none";
        document.getElementById("loading").innerText =
          "Farcaster preferred wallet required. Open in Warpcast or Farcaster compatible Frame.";
        document.getElementById("loading").style.display = "";
      }
    }

    // ---- Game logic: local leaderboard/stats for demo only ----
    function fetchStats() {
      let key = "flip-"+stats.addr;
      let val = localStorage.getItem(key);
      if(val) Object.assign(stats, JSON.parse(val));
      updateStats();
      updateLeaderboard();
    }
    function updateStats() {
      document.getElementById("statFlips").innerText = stats.flips;
      document.getElementById("statRewards").innerText = stats.rewards;
    }

    // -------------- Flip coin logic --------------
    document.getElementById("flipBtn").onclick = function() {
      const btn = this;
      btn.disabled = true;
      let heads = Math.random() < 0.5;
      let coin = document.getElementById("coin");
      coin.style.transition = ".8s cubic-bezier(.19,1,.22,1)";
      coin.style.transform = "rotateY(1800deg)";
      setTimeout(()=>{
        coin.style.transform = "";
        if(heads) {
          coin.className = "coin heads";
          coin.innerText = "H";
          stats.rewards++;
          toast("Heads! Reward on Arbitrum üéâ");
        } else {
          coin.className = "coin tails";
          coin.innerText = "T";
          toast("Tails. No reward.",1);
        }
        stats.flips++;
        updateStats();
        localStorage.setItem("flip-"+stats.addr,JSON.stringify(stats));
        updateLeaderboard();
        btn.disabled = false;
      }, 800);
    };

    // ----------- Leaderboard (top 10 local) -----------
    function updateLeaderboard() {
      let arr = [];
      for(let k in localStorage) {
        if(k.startsWith("flip-")) {
          let o = JSON.parse(localStorage[k]);
          arr.push({ addr: o.addr, flips: o.flips||0, rewards: o.rewards||0 });
        }
      }
      // Add self (in case not saved yet)
      if(stats.addr) arr.push({ addr: stats.addr, flips: stats.flips, rewards: stats.rewards });
      arr = arr.filter(x=>x.addr);
      arr = Object.values(arr.reduce((acc,cur)=>{acc[cur.addr]=cur;return acc;},{}));
      arr.sort((a,b)=>b.flips-a.flips);
      arr = arr.slice(0,10);
      document.getElementById("lb").innerHTML =
        arr.map((x,i)=>`<div class="lb-row"><div>
        #${i+1} ${(x.addr||"0x...").slice(0,6)}...${(x.addr||"0x...").slice(-4)}
        </div><div>${x.flips} / ${x.rewards}</div></div>`).join("");
    }

    // ------------- Mount everything -------------
    tryAutoConnect();
  </script>
</body>
</html>
